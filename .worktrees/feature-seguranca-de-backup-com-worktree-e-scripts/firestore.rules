rules_version = '2';

// ===========================================
// FIRESTORE SECURITY RULES - ODYSSEY APP
// ===========================================
// 
// COMO APLICAR:
// 1. Acesse o Firebase Console: https://console.firebase.google.com
// 2. Selecione o projeto "odyssey-7d931"
// 3. Vá em Firestore Database > Rules
// 4. Cole este conteúdo e clique em "Publish"
//
// ===========================================

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===========================================
    // REGRAS GLOBAIS
    // ===========================================
    
    // Por padrão, negar todo acesso
    match /{document=**} {
      allow read, write: if false;
    }
    
    // ===========================================
    // COLEÇÃO DE USUÁRIOS
    // ===========================================
    
    match /users/{userId} {
      // Usuário pode ler e escrever APENAS seus próprios dados
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Subcoleções do usuário (moods, tasks, habits, notes, quotes)
      match /{subcollection}/{documentId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // ===========================================
    // COLEÇÃO PÚBLICA (ex: configurações globais)
    // ===========================================
    
    match /app_config/{document} {
      // Qualquer usuário autenticado pode ler
      allow read: if request.auth != null;
      // Apenas admins podem escrever (via Firebase Admin SDK)
      allow write: if false;
    }
    
    // ===========================================
    // COLEÇÃO DE QUOTES GLOBAIS (se houver)
    // ===========================================
    
    match /global_quotes/{quoteId} {
      // Qualquer usuário autenticado pode ler
      allow read: if request.auth != null;
      // Apenas admins podem escrever
      allow write: if false;
    }
    
    // ===========================================
    // FUNÇÕES AUXILIARES
    // ===========================================
    
    // Verifica se o usuário está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verifica se o usuário é o dono do documento
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Verifica se os dados são válidos para um mood record
    function isValidMoodRecord(data) {
      return data.keys().hasAll(['label', 'score', 'date']) &&
             data.score is int &&
             data.score >= 1 &&
             data.score <= 5;
    }
    
    // Verifica se os dados são válidos para um habit
    function isValidHabit(data) {
      return data.keys().hasAll(['id', 'name', 'iconCode']) &&
             data.name is string &&
             data.name.size() > 0;
    }
  }
}
