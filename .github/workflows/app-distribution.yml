# ==============================================================================
# ğŸ“± Odyssey - Firebase App Distribution
# ==============================================================================
# Este workflow distribui o app automaticamente para beta testers
# Roda apenas em releases ou quando disparado manualmente
# ==============================================================================

name: ğŸ“± App Distribution

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_notes:
        description: 'Release notes para os testers'
        required: false
        default: 'Nova versÃ£o beta disponÃ­vel!'
      groups:
        description: 'Grupos de testers (separados por vÃ­rgula)'
        required: false
        default: 'internal-testers'

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  # ============================================================================
  # JOB: Build & Distribute
  # ============================================================================
  distribute:
    name: ğŸ“¤ Build & Distribute
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ”„ Generate code (Freezed, Hive, Isar)
        run: dart run build_runner build --delete-conflicting-outputs

      - name: ğŸŒ Generate localizations
        run: flutter gen-l10n

      # --------------------------------------------------------------------
      # Configurar keystore para release build
      # --------------------------------------------------------------------
      - name: ğŸ” Setup Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/odyssey-key.jks
          echo "storeFile=odyssey-key.jks" >> android/key.properties
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties

      # --------------------------------------------------------------------
      # Build Release APK
      # --------------------------------------------------------------------
      - name: ğŸ—ï¸ Build Release APK
        run: flutter build apk --release

      # --------------------------------------------------------------------
      # Upload para Firebase App Distribution
      # --------------------------------------------------------------------
      - name: ğŸ” Authenticate to Firebase
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCLOUD_SERVICE_ACCOUNT_KEY }}

      - name: ğŸ“¤ Upload to App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          serviceCredentialsFileContent: ${{ secrets.GCLOUD_SERVICE_ACCOUNT_KEY }}
          groups: ${{ github.event.inputs.groups || 'internal-testers' }}
          file: build/app/outputs/flutter-apk/app-release.apk
          releaseNotes: |
            ${{ github.event.inputs.release_notes || github.event.release.body || 'Nova versÃ£o beta disponÃ­vel!' }}
            
            ---
            ğŸ“¦ Build: ${{ github.run_number }}
            ğŸ”– Commit: ${{ github.sha }}
            ğŸ—“ï¸ Data: ${{ github.event.repository.updated_at }}

      # --------------------------------------------------------------------
      # NotificaÃ§Ã£o (opcional)
      # --------------------------------------------------------------------
      - name: ğŸ“£ Notify Success
        if: success()
        run: |
          echo "âœ… App distribuÃ­do com sucesso!"
          echo "ğŸ“± Testers receberÃ£o notificaÃ§Ã£o por email"
          echo ""
          echo "ğŸ“Š Dashboard: https://console.firebase.google.com/project/${{ secrets.FIREBASE_PROJECT_ID }}/appdistribution"
