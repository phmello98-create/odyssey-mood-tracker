# ==============================================================================
# ğŸ§ª Odyssey - Firebase Test Lab CI/CD
# ==============================================================================
# Este workflow roda Robo Tests automaticamente em cada push para main/develop
# e em PRs, testando o app em mÃºltiplos devices Android reais na nuvem
# ==============================================================================

name: ğŸ§ª Firebase Test Lab

on:
  push:
    branches: 
      - main
      - develop
  pull_request:
    branches: 
      - main
      - develop
  workflow_dispatch:  # Permite rodar manualmente

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  # ============================================================================
  # JOB 1: Build APK
  # ============================================================================
  build:
    name: ğŸ“¦ Build APK
    runs-on: ubuntu-latest
    outputs:
      apk_path: ${{ steps.build.outputs.apk_path }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ”„ Generate code (Freezed, Hive, Isar)
        run: dart run build_runner build --delete-conflicting-outputs

      - name: ğŸŒ Generate localizations
        run: flutter gen-l10n

      - name: ğŸ” Analyze code
        run: flutter analyze --no-fatal-infos
        continue-on-error: true

      - name: ğŸ—ï¸ Build Debug APK
        id: build
        run: |
          flutter build apk --debug
          echo "apk_path=build/app/outputs/flutter-apk/app-debug.apk" >> $GITHUB_OUTPUT

      - name: ğŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7

  # ============================================================================
  # JOB 2: Robo Test
  # ============================================================================
  robo-test:
    name: ğŸ¤– Robo Test
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ğŸ“¥ Download APK
        uses: actions/download-artifact@v4
        with:
          name: debug-apk
          path: ./apk

      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCLOUD_SERVICE_ACCOUNT_KEY }}

      - name: ğŸ› ï¸ Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: ğŸ§ª Run Robo Test on Firebase Test Lab
        run: |
          gcloud firebase test android run \
            --app ./apk/app-debug.apk \
            --type robo \
            --device model=oriole,version=33,locale=pt_BR,orientation=portrait \
            --device model=redfin,version=30,locale=pt_BR,orientation=portrait \
            --device model=bluejay,version=32,locale=pt_BR,orientation=portrait \
            --timeout 300s \
            --results-bucket=${{ secrets.FIREBASE_PROJECT_ID }}-test-results \
            --results-dir=odyssey-${{ github.run_number }}-${{ github.sha }}

      - name: ğŸ“Š Get Test Results
        if: always()
        run: |
          echo "ğŸ“Š Test results available at:"
          echo "https://console.firebase.google.com/project/${{ secrets.FIREBASE_PROJECT_ID }}/testlab/histories"

  # ============================================================================
  # JOB 3: Instrumentation Test (opcional, se tiver testes de integraÃ§Ã£o)
  # ============================================================================
  # instrumentation-test:
  #   name: ğŸ”¬ Integration Tests
  #   runs-on: ubuntu-latest
  #   needs: build
  #   
  #   steps:
  #     - name: ğŸ“¥ Checkout
  #       uses: actions/checkout@v4
  #     
  #     - name: ğŸ¦ Setup Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: ${{ env.FLUTTER_VERSION }}
  #     
  #     - name: ğŸ§ª Build Instrumentation Test APKs
  #       run: |
  #         pushd android
  #         ./gradlew app:assembleDebug app:assembleDebugAndroidTest
  #         popd
  #     
  #     - name: ğŸ” Authenticate to Google Cloud
  #       uses: google-github-actions/auth@v2
  #       with:
  #         credentials_json: ${{ secrets.GCLOUD_SERVICE_ACCOUNT_KEY }}
  #     
  #     - name: ğŸ§ª Run Instrumentation Tests
  #       run: |
  #         gcloud firebase test android run \
  #           --type instrumentation \
  #           --app build/app/outputs/apk/debug/app-debug.apk \
  #           --test build/app/outputs/apk/androidTest/debug/app-debug-androidTest.apk \
  #           --device model=oriole,version=33
